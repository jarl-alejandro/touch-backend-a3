!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReactDnDTouchBackend=t()}(this,(function(){"use strict";var e;!function(e){e.mouse="mouse",e.touch="touch",e.keyboard="keyboard"}(e||(e={}));var t=1,n=0;function o(e){return void 0===e.button||e.button===n}function r(e){return!!e.targetTouches}var i=function(e,t){for(;e;){if(e.matches&&e.matches(t))return e;e=e.parentNode}return null};function s(e,t){return r(e)?function(e,t){return 1===e.targetTouches.length?s(e.targetTouches[0]):t&&1===e.touches.length&&e.touches[0].target===t.target?s(e.touches[0]):void 0}(e,t):{x:e.clientX,y:e.clientY}}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var u,d=function(){function e(t,n){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.enableTouchEvents=!0,this.enableMouseEvents=!1,this.enableKeyboardEvents=!1,this.ignoreContextMenu=!1,this.enableHoverOutsideTarget=!1,this.touchSlop=0,this.scrollAngleRanges=void 0,this.context=n,this.delayTouchStart=t.delayTouchStart||t.delay||0,this.delayMouseStart=t.delayMouseStart||t.delay||0,Object.keys(t).forEach((function(e){null!=t[e]&&(o[e]=t[e])}))}var t,n,o;return t=e,(n=[{key:"window",get:function(){return this.context&&this.context.window?this.context.window:"undefined"!=typeof window?window:void 0}},{key:"document",get:function(){if(this.window)return this.window.document}}])&&a(t.prototype,n),o&&a(t,o),e}();function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=(l(u={},e.mouse,{start:"mousedown",move:"mousemove",end:"mouseup",contextmenu:"contextmenu"}),l(u,e.touch,{start:"touchstart",move:"touchmove",end:"touchend"}),l(u,e.keyboard,{keydown:"keydown"}),u),v=function(){function n(a,u,c){var l=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.getSourceClientOffset=function(e){return function(e){var t=1===e.nodeType?e:e.parentElement;if(t){var n=t.getBoundingClientRect(),o=n.top;return{x:n.left,y:o}}}(l.sourceNodes[e])},this.handleTopMoveStartCapture=function(e){o(e)&&(l.moveStartSourceIds=[])},this.handleMoveStart=function(e){Array.isArray(l.moveStartSourceIds)&&l.moveStartSourceIds.unshift(e)},this.handleTopMoveStart=function(e){if(o(e)){if(n=e.target,i(n,".TreeViewSection")){var t=i(e.target,".TreeView-box");console.log(t),t&&(t.classList.add("is-draggin-a3"),navigator.vibrate([1]))}var n,a=s(e);a&&(r(e)&&(l.lastTargetTouchFallback=e.targetTouches[0]),l._mouseClientOffset=a),l.waitingForDelay=!1}},this.handleTopMoveStartDelay=function(e){if(o(e)){var t=e.type===h.touch.start?l.options.delayTouchStart:l.options.delayMouseStart;l.timeout=setTimeout(l.handleTopMoveStart.bind(l,e),t),l.waitingForDelay=!0}},this.handleTopMoveCapture=function(){l.dragOverTargetIds=[]},this.handleMove=function(e,t){var n=document.querySelector(".is-draggin-a3");console.log(n),n&&n.classList.remove("is-draggin-a3"),l.dragOverTargetIds&&l.dragOverTargetIds.unshift(t)},this.handleTopMove=function(e){var t=document.querySelector(".is-draggin-a3");if(console.log(t),t&&t.classList.remove("is-draggin-a3"),l.timeout&&clearTimeout(l.timeout),l.document&&!l.waitingForDelay){var n,o,r,i,a=l.moveStartSourceIds,u=l.dragOverTargetIds,d=l.options.enableHoverOutsideTarget,c=s(e,l.lastTargetTouchFallback);if(c)if(l._isScrolling||!l.monitor.isDragging()&&function(e,t,n,o,r){if(!r)return!1;for(var i=180*Math.atan2(o-t,n-e)/Math.PI+180,s=0;s<r.length;++s)if((null==r[s].start||i>=r[s].start)&&(null==r[s].end||i<=r[s].end))return!0;return!1}(l._mouseClientOffset.x||0,l._mouseClientOffset.y||0,c.x,c.y,l.options.scrollAngleRanges))l._isScrolling=!0;else if(!l.monitor.isDragging()&&l._mouseClientOffset.hasOwnProperty("x")&&a&&(n=l._mouseClientOffset.x||0,o=l._mouseClientOffset.y||0,r=c.x,i=c.y,Math.sqrt(Math.pow(Math.abs(r-n),2)+Math.pow(Math.abs(i-o),2))>(l.options.touchSlop?l.options.touchSlop:0))&&(l.moveStartSourceIds=void 0,l.actions.beginDrag(a,{clientOffset:l._mouseClientOffset,getSourceClientOffset:l.getSourceClientOffset,publishSource:!1})),l.monitor.isDragging()){var h=l.sourceNodes[l.monitor.getSourceId()];l.installSourceNodeRemovalObserver(h),l.actions.publishDragSource(),e.preventDefault();var v=(u||[]).map((function(e){return l.targetNodes[e]})),f=l.options.getDropTargetElementsAtPoint?l.options.getDropTargetElementsAtPoint(c.x,c.y,v):l.document.elementsFromPoint(c.x,c.y),g=[];for(var m in f)if(f.hasOwnProperty(m)){var p=f[m];for(g.push(p);p;)p=p.parentElement,-1===g.indexOf(p)&&g.push(p)}var w=g.filter((function(e){return v.indexOf(e)>-1})).map((function(e){for(var t in l.targetNodes)if(e===l.targetNodes[t])return t})).filter((function(e){return!!e})).filter((function(e,t,n){return n.indexOf(e)===t}));if(d)for(var y in l.targetNodes)if(l.targetNodes[y]&&l.targetNodes[y].contains(h)&&-1===w.indexOf(y)){w.unshift(y);break}w.reverse(),l.actions.hover(w,{clientOffset:c})}}},this.handleTopMoveEndCapture=function(e){var n=document.querySelector(".is-draggin-a3");console.log(n),n&&n.classList.remove("is-draggin-a3"),l._isScrolling=!1,l.lastTargetTouchFallback=void 0,function(e){return void 0===e.buttons||0==(e.buttons&t)}(e)&&(l.monitor.isDragging()&&!l.monitor.didDrop()?(e.preventDefault(),l._mouseClientOffset={},l.uninstallSourceNodeRemovalObserver(),l.actions.drop(),l.actions.endDrag()):l.moveStartSourceIds=void 0)},this.handleCancelOnEscape=function(e){"Escape"===e.key&&l.monitor.isDragging()&&(l._mouseClientOffset={},l.uninstallSourceNodeRemovalObserver(),l.actions.endDrag())},this.options=new d(c,u),this.actions=a.getActions(),this.monitor=a.getMonitor(),this.sourceNodes={},this.sourcePreviewNodes={},this.sourcePreviewNodeOptions={},this.targetNodes={},this.listenerTypes=[],this._mouseClientOffset={},this._isScrolling=!1,this.options.enableMouseEvents&&this.listenerTypes.push(e.mouse),this.options.enableTouchEvents&&this.listenerTypes.push(e.touch),this.options.enableKeyboardEvents&&this.listenerTypes.push(e.keyboard)}var a,u,l;return a=n,(u=[{key:"setup",value:function(){this.window&&(function(e,t){for(var n=arguments.length,o=new Array(n>2?n-2:0),r=2;r<n;r++)o[r-2]=arguments[r];if("production"!=="production"&&void 0===t)throw new Error("invariant requires an error message argument");if(!e){var i;if(void 0===t)i=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var s=0;(i=new Error(t.replace(/%s/g,(function(){return o[s++]})))).name="Invariant Violation"}throw i.framesToPop=1,i}}(!n.isSetUp,"Cannot have two Touch backends at the same time."),n.isSetUp=!0,this.addEventListener(this.window,"start",this.getTopMoveStartHandler()),this.addEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.addEventListener(this.window,"move",this.handleTopMove),this.addEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.addEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.addEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.addEventListener(this.window,"keydown",this.handleCancelOnEscape,!0))}},{key:"teardown",value:function(){this.window&&(n.isSetUp=!1,this._mouseClientOffset={},this.removeEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.removeEventListener(this.window,"start",this.handleTopMoveStartDelay),this.removeEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.removeEventListener(this.window,"move",this.handleTopMove),this.removeEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.removeEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.removeEventListener(this.window,"keydown",this.handleCancelOnEscape,!0),this.uninstallSourceNodeRemovalObserver())}},{key:"addEventListener",value:function(e,t,n,o){var r=o;this.listenerTypes.forEach((function(o){var i=h[o][t];i&&e.addEventListener(i,n,r)}))}},{key:"removeEventListener",value:function(e,t,n,o){var r=o;this.listenerTypes.forEach((function(o){var i=h[o][t];i&&e.removeEventListener(i,n,r)}))}},{key:"connectDragSource",value:function(e,t){var n=this,o=this.handleMoveStart.bind(this,e);return this.sourceNodes[e]=t,this.addEventListener(t,"start",o),function(){delete n.sourceNodes[e],n.removeEventListener(t,"start",o)}}},{key:"connectDragPreview",value:function(e,t,n){var o=this;return this.sourcePreviewNodeOptions[e]=n,this.sourcePreviewNodes[e]=t,function(){delete o.sourcePreviewNodes[e],delete o.sourcePreviewNodeOptions[e]}}},{key:"connectDropTarget",value:function(e,t){var n=this;if(!this.document)return function(){return null};var o=function(o){if(n.document&&n.monitor.isDragging()){var r;switch(o.type){case h.mouse.move:r={x:o.clientX,y:o.clientY};break;case h.touch.move:r={x:o.touches[0].clientX,y:o.touches[0].clientY}}var i=null!=r?n.document.elementFromPoint(r.x,r.y):void 0,s=i&&t.contains(i);return i===t||s?n.handleMove(o,e):void 0}};return this.addEventListener(this.document.body,"move",o),this.targetNodes[e]=t,function(){n.document&&(delete n.targetNodes[e],n.removeEventListener(n.document.body,"move",o))}}},{key:"getTopMoveStartHandler",value:function(){return this.handleTopMoveStartDelay}},{key:"installSourceNodeRemovalObserver",value:function(e){var t=this;this.uninstallSourceNodeRemovalObserver(),this.draggedSourceNode=e,this.draggedSourceNodeRemovalObserver=new MutationObserver((function(){e&&!e.parentElement&&(t.resurrectSourceNode(),t.uninstallSourceNodeRemovalObserver())})),e&&e.parentElement&&this.draggedSourceNodeRemovalObserver.observe(e.parentElement,{childList:!0})}},{key:"resurrectSourceNode",value:function(){this.document&&this.draggedSourceNode&&(this.draggedSourceNode.style.display="none",this.draggedSourceNode.removeAttribute("data-reactid"),this.document.body.appendChild(this.draggedSourceNode))}},{key:"uninstallSourceNodeRemovalObserver",value:function(){this.draggedSourceNodeRemovalObserver&&this.draggedSourceNodeRemovalObserver.disconnect(),this.draggedSourceNodeRemovalObserver=void 0,this.draggedSourceNode=void 0}},{key:"window",get:function(){return this.options.window}},{key:"document",get:function(){if(this.window)return this.window.document}}])&&c(a.prototype,u),l&&c(a,l),n}();return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new v(e,t,n)}}));
